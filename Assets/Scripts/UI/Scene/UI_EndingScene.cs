using System.Collections;
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using UnityEngine.Video;

public class UI_EndingScene : UI_Scene
{
	[SerializeField] private TMP_Text _newsText;       // 뉴스 대사 텍스트
	[SerializeField] private TMP_Text _finalText;      // 검은화면 텍스트
    [SerializeField] private GameObject _bubbleImage;  // 말풍선 이미지
    [SerializeField] private Image _fadeImage;

    [SerializeField] private VideoPlayer _endingVideoPlayer; // 마지막 글자 글리지 효과

    private EndingSceneData _sceneData;
	public override void Init()
	{
		base.Init();
        Canvas canvas = GetComponent<Canvas>();
        canvas.renderMode = RenderMode.ScreenSpaceCamera;
        canvas.worldCamera = Camera.main;

        _sceneData = Managers.DB.GetEndingSceneData();

        _newsText.text = "";       // 뉴스 텍스트 초기화
		_finalText.text = "";      // 제목 텍스트 초기화
        _bubbleImage.SetActive(false); // 말풍선 이미지 비활성화

        StartCoroutine(PlayEndingSequence());
	}

    [SerializeField] WebGLVideoPlayer _webGLVideoPlayer; // WebGL에서 비디오 재생을 위한 컴포넌트
    private IEnumerator PlayEndingSequence()
	{
		yield return new WaitForSeconds(0.5f);
        _bubbleImage.SetActive(true); // 말풍선 이미지 활성화
        
        _newsText.text = _sceneData.newsDialog[0];
        //ResizeBubbleImage(_sceneData.newsDialog[0]); // 말풍선 이미지 크기 조정

        yield return WaitForSecondsCache.Get(1.5f); // 1초 대기

        System.Action cache = () => { Managers.Sound.Play("keyboard_oneshot2", Sound.Effect); };
        // 뉴스 텍스트 출력
        for (int i = 1; i < _sceneData.newsDialog.Count; i++)
        {
            //ResizeBubbleImage(_sceneData.newsDialog[i]);
            yield return _newsText.CoTypeEffectWithRichText(_sceneData.newsDialog[i], 0.1f, cache);
        }

		Managers.Sound.StopSubEffect();

		// 화면 fadeOut
		_fadeImage.gameObject.SetActive(true);

        Coroutine c1 = StartCoroutine(Managers.Sound.FadeOutSubEffect(2f));
        Coroutine c2 = StartCoroutine(_fadeImage.CoFadeOut(1f, 0f, 1f));
        yield return c1; yield return c2;
        
        //yield return WaitForSecondsCache.Get(1f); // 1초 대기

        // 검은 화면상의 텍스트 출력
        foreach (var finalDialogue in _sceneData.finalDialog)
        {
            yield return _finalText.CoTypeEffectWithRichText(finalDialogue, 0.1f, cache);
        }

        _finalText.text = "";

        yield return WaitForSecondsCache.Get(2f);
        _endingVideoPlayer.gameObject.SetActive(true); // Ending Video Player 활성화
        _webGLVideoPlayer.PlayOverlayVideo("glitch.mp4"); // WebGL에서 비디오 재생
        Managers.Sound.Play("titleName", Sound.Effect);
        yield return WaitForSecondsCache.Get(7f); // 0.5초 대기

        // 메인 화면으로 전환
        Managers.Scene.LoadScene(Scene.TitleScene); // Main Title Scene으로 전환
    }
}
