using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class LibraryIDHooks : MonoBehaviour, IDialogueHookProvider
{
	[Header("Scene refs")]
	public LibraryScene library;        // (???? ???? ?? ????????)
	public PlayerController player;     // ????????
	public Transform librarian;         // ???? Transform

	[Header("Anchors")]
	public Vector3 pos2 = new Vector3(22.23f, -4.46f, 0);              // ?????? ????(2)??
	public Vector3 pos3 = new Vector3(25.32f, -4.46f, 0);               // ?????? ????(3)??

	[Header("Move settings")]
	public float walkSpeed = 2.2f;
	public float arriveEps = 0.05f;

	UILetterboxOverlay _letterbox;
	bool _startTimelineEnded;
	Coroutine _moveCo;

	void Awake()
	{
		if (library == null) 
			library = FindAnyObjectByType<LibraryScene>();

		if (player == null) 
			player = FindAnyObjectByType<PlayerController>();

		_letterbox = UILetterboxOverlay.GetOrCreate();

		if (library != null)
			library.onStartTimeLineEnd += () => _startTimelineEnded = true;
	}

	public IEnumerator OnPreEnter(string id)
	{
		switch (id)
		{
			// 2001001: ????????(=???????? 1?? ???? ????)???? ???? ?? ???????? Out + ????????
			case "2001001":
				
				librarian.GetComponentInChildren<Animator>().CrossFade("Library_ch_sit_idle", 0.01f);

				// ???????? ???? ????
				yield return new WaitUntil(() => _startTimelineEnded);

				// ???? ???? ???? ????
				if (player != null)
					player.canMove = false;

				float baseH = Screen.height * 0.1f;
				float overshoot = baseH;
				float settle = baseH * 0.85f;        // 10 ?? 7 ???????? 70%

				yield return _letterbox.OpenOvershoot(settle, overshoot, 250f);

				yield break;

			// 2001004: ?????? 3??2?? ???? ????(???? ???? ???? ?? ???????? ?????? ??????)
			case "2001004":
				// ???? ????: 3(???? ???? ????) -> 2??
				if (librarian != null)
				{
					// ???? ???????? ?????? ????
					if (_moveCo != null) 
						StopCoroutine(_moveCo);

					_moveCo = StartCoroutine(CoMoveTo(librarian, pos2, walkSpeed, arriveEps));
				}
				yield break;

			// 2001005: ?????? ?????? ?????? ???? ?????? ????
			case "2001005":
				if (_moveCo != null) 
					yield return _moveCo;
				yield break;

			default:
				yield break;
		}
	}

	IEnumerator CoMoveTo(Transform who, Vector3 target, float speed, float eps)
	{
		if (who == null) 
			yield break;

		// Z ????(2D)
		target.z = who.position.z;

		while (true)
		{
			var pos = who.position;
			var dir = (target - pos);
			dir.z = 0f;
			float dist = dir.magnitude;
			if (dist <= eps) break;

			if (dist > 0.0001f)
			{
				var step = Mathf.Min(dist, speed * Time.deltaTime);
				who.position = pos + dir.normalized * step;
			}
			yield return null;
		}
	}
}
